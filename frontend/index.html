<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Austender Analyser Chat</title>
    <!-- Environment config -->
    <script src="./config.local.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/markdown-it-katex@2.0.3/index.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: linear-gradient(135deg, #f7f9fc 0%, #eef2f7 100%); }
        .chat-card { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08); border: none; }
        .chat-log { height: 400px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .msg { margin-bottom: 1rem; }
        .msg .role { font-weight: 600; color: #0d6efd; }
        .msg.assistant .role { color: #20c997; }
        .context { font-size: 0.85rem; color: #6c757d; margin-top: 0.25rem; }
        .pill { display: inline-block; padding: 0.35rem 0.6rem; border-radius: 999px; background: #0d6efd; color: #fff; font-size: 0.8rem; }
    </style>
</head>
<body class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-3">
                <div class="pill me-2">Chat</div>
                <h1 class="m-0">Austender Analyser</h1>
            </div>
            <p class="text-muted">Ask spend questions in plain text. Toggle MCP to let the model call local MCP tools.</p>

            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="toggle-mcp" checked>
                <label class="form-check-label" for="toggle-mcp">Enable MCP backend (includes config in the request)</label>
            </div>

            <div class="card chat-card mb-3">
                <div class="card-body">
                    <div id="chat-log" class="chat-log" aria-live="polite"></div>
                    <form id="chat-form" class="mt-3" hx-ext="json-enc" hx-encoding="json" hx-swap="none">
                        <label for="prompt" class="form-label">Your question</label>
                        <textarea id="prompt" name="prompt" class="form-control" rows="3" placeholder="e.g., How much was spent by Department of Defence?" required></textarea>
                        <div class="d-flex align-items-center mt-3">
                            <button type="submit" class="btn btn-primary" id="sendBtn">
                                <span class="spinner-border spinner-border-sm htmx-indicator me-2" role="status" aria-hidden="true"></span>
                                Send
                            </button>
                            <div class="ms-3 text-muted" id="status-msg"></div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="small text-muted">Requests POST to `/api/llm`. MCP config is attached only when the toggle is on.</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var apiBase = (window.APP_CONFIG && window.APP_CONFIG.apiBase) || 'http://localhost:8080';
            var mcpConfig = (window.APP_CONFIG && window.APP_CONFIG.mcpConfig) || null;
            var form = document.getElementById('chat-form');
            var promptEl = document.getElementById('prompt');
            var logEl = document.getElementById('chat-log');
            var sendBtn = document.getElementById('sendBtn');
            var statusEl = document.getElementById('status-msg');
            var toggleMcp = document.getElementById('toggle-mcp');

            // Rich renderer: markdown-it + katex + DOMPurify with re-render once deps load
            var md;
            var pendingRenders = [];
            function tryInitRenderer() {
                if (!md && window.markdownit && window.markdownitKatex && window.DOMPurify && window.katex) {
                    md = window.markdownit({
                        html: false,
                        linkify: true,
                        breaks: true
                    }).use(window.markdownitKatex, { throwOnError: false, output: 'html' });
                    flushPending();
                }
            }
            function normalizeMathDelimiters(text) {
                if (!text) return text;
                // Convert \[ ... \] to $$ ... $$ for consistent katex parsing.
                return text.replace(/\\\[/g, '$$').replace(/\\\]/g, '$$');
            }

            function renderInto(el, text) {
                if (!text) {
                    el.innerHTML = '';
                    return;
                }
                var source = normalizeMathDelimiters(text);
                if (!md) {
                    el.textContent = source;
                    pendingRenders.push({ el: el, text: source });
                    return;
                }
                el.innerHTML = window.DOMPurify.sanitize(md.render(source));
            }
            function flushPending() {
                if (!md) return;
                pendingRenders.forEach(function(item) {
                    item.el.innerHTML = window.DOMPurify.sanitize(md.render(item.text));
                });
                pendingRenders = [];
            }
            // Poll briefly until renderer is ready (deferred scripts)
            var rendererInterval = setInterval(function() {
                tryInitRenderer();
                if (md) clearInterval(rendererInterval);
            }, 50);
            setTimeout(function(){ if (!md) tryInitRenderer(); }, 2000);

            function appendMessage(role, text, context) {
                var wrapper = document.createElement('div');
                wrapper.className = 'msg ' + role.toLowerCase();

                var roleEl = document.createElement('div');
                roleEl.className = 'role';
                roleEl.textContent = role;

                var textEl = document.createElement('div');
                renderInto(textEl, text);

                wrapper.appendChild(roleEl);
                wrapper.appendChild(textEl);

                if (context) {
                    var ctxEl = document.createElement('div');
                    ctxEl.className = 'context';
                    renderInto(ctxEl, 'Context: ' + context);
                    wrapper.appendChild(ctxEl);
                }

                logEl.appendChild(wrapper);
                logEl.scrollTop = logEl.scrollHeight;
            }

            async function sendPrompt(prompt) {
                var payload = { prompt: prompt, prefetch: !!toggleMcp.checked };
                if (toggleMcp.checked && mcpConfig) {
                    payload.mcpConfig = mcpConfig;
                }

                statusEl.textContent = 'Sending...';
                sendBtn.disabled = true;
                try {
                    var res = await fetch(apiBase.replace(/\/$/, '') + '/api/llm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    var data = await res.json();
                    appendMessage('Assistant', data.result || '[no result]', data.context);
                } catch (err) {
                    appendMessage('Assistant', 'Error: ' + err.message);
                } finally {
                    sendBtn.disabled = false;
                    statusEl.textContent = '';
                }
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                var prompt = (promptEl.value || '').trim();
                if (!prompt) return;
                appendMessage('You', prompt);
                promptEl.value = '';
                sendPrompt(prompt);
            });
        });
    </script>
</body>
</html>
